# Polymarket Smart Money Dashboard 架构设计

**版本**：v0.1 (MVP)
**作者**：Khalil
**时间**：2026-01

---

## 目录

1. [总体架构](#1-总体架构)
2. [核心组件](#2-核心组件)
3. [数据流](#3-数据流)
4. [技术选型](#4-技术选型)
5. [目录结构](#5-目录结构)
6. [部署架构](#6-部署架构)
7. [安全模型](#7-安全模型)
8. [异常处理](#8-异常处理)
9. [设计原则](#9-设计原则)
10. [演进路线](#10-演进路线)

---

## 1. 总体架构

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         External Services                            │
├────────────────────────────────┬────────────────────────────────────┤
│         Polygon RPC            │        Gamma Markets API            │
│    ┌─────────────────────┐     │     ┌─────────────────────┐        │
│    │  eth_getLogs        │     │     │  GET /markets       │        │
│    │  eth_blockNumber    │     │     │  Market Metadata    │        │
│    └──────────┬──────────┘     │     └──────────┬──────────┘        │
└───────────────┼────────────────┴────────────────┼───────────────────┘
                │                                  │
                ▼                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          Backend Layer                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐     │
│   │   Indexer   │    │   Market    │    │    Trade Decoder    │     │
│   │             │    │   Service   │    │                     │     │
│   │ • 日志扫描   │    │ • API 调用  │    │ • 方向判定          │     │
│   │ • 事件过滤   │    │ • 缓存管理  │    │ • 价格计算          │     │
│   │ • ABI 解码   │    │ • 映射构建  │    │ • 数据转换          │     │
│   └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘     │
│          │                  │                       │                │
│          └──────────────────┼───────────────────────┘                │
│                             ▼                                        │
│                    ┌─────────────────┐                               │
│                    │   Repository    │                               │
│                    │                 │                               │
│                    │ • CRUD 操作     │                               │
│                    │ • 聚合查询      │                               │
│                    │ • 事务管理      │                               │
│                    └────────┬────────┘                               │
│                             │                                        │
│                             ▼                                        │
│                    ┌─────────────────┐                               │
│                    │     SQLite      │                               │
│                    │                 │                               │
│                    │ • markets       │                               │
│                    │ • trades        │                               │
│                    │ • address_tags  │                               │
│                    └────────┬────────┘                               │
│                             │                                        │
│                             ▼                                        │
│                    ┌─────────────────┐                               │
│                    │   API Routes    │                               │
│                    │  (Next.js)      │                               │
│                    │                 │                               │
│                    │ • /api/trades   │                               │
│                    │ • /api/markets  │                               │
│                    │ • /api/traders  │                               │
│                    │ • /api/tags     │                               │
│                    └────────┬────────┘                               │
│                             │                                        │
└─────────────────────────────┼────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Frontend Layer                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐  │
│   │   Trades    │  │   Markets   │  │   Traders   │  │  Address  │  │
│   │   Table     │  │   Charts    │  │ Leaderboard │  │  Drawer   │  │
│   │             │  │             │  │             │  │           │  │
│   │ • 交易列表   │  │ • 柱状图    │  │ • 排行榜    │  │ • 详情    │  │
│   │ • 筛选      │  │ • 价格折线  │  │ • 标签      │  │ • 历史    │  │
│   │ • 分页      │  │ • 统计卡片  │  │ • 搜索      │  │ • 标签    │  │
│   └─────────────┘  └─────────────┘  └─────────────┘  └───────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 分层说明

| 层级 | 职责 | 技术 |
|------|------|------|
| **External Services** | 链上数据 + 市场元数据 | Polygon RPC, Gamma API |
| **Backend Layer** | 数据采集、处理、存储、API | Node.js, Prisma, SQLite |
| **Frontend Layer** | 可视化展示 | Next.js, React, Recharts |

---

## 2. 核心组件

### 2.1 组件职责表

| 组件 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **Indexer** | 扫描 Polygon 区块日志 | RPC URL, 区块范围 | Raw Logs |
| **Market Service** | 获取市场元数据 | Gamma API | Market[], TokenMapping |
| **Trade Decoder** | 解码交易数据 | Raw Log, TokenMapping | DecodedTrade |
| **Repository** | 数据库操作 | DecodedTrade, Query | DB Records |
| **API Routes** | HTTP 接口 | HTTP Request | JSON Response |
| **Dashboard** | 可视化界面 | JSON Data | UI Components |

### 2.2 组件交互图

```
┌──────────────────────────────────────────────────────────────┐
│                     初始化阶段                                │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  Market Service ─────► Repository ─────► SQLite              │
│       │                    ▲                                 │
│       │                    │                                 │
│       ▼                    │                                 │
│  TokenMapping ────────────►│                                 │
│       │                    │                                 │
│       ▼                    │                                 │
│  Indexer ──► Trade Decoder ┘                                 │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                     运行时阶段                                │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  Browser ──► API Routes ──► Repository ──► SQLite            │
│     ▲              │                          │              │
│     │              ▼                          │              │
│     └─────── JSON Response ◄──────────────────┘              │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 2.3 组件详情

#### Indexer（链上索引器）

```
职责：
├── 连接 Polygon RPC
├── 获取最新区块号
├── 按区块范围扫描日志
├── 过滤 OrderFilled 事件
└── 传递给 Trade Decoder

配置参数：
├── rpcUrl: string
├── contractAddress: string
├── blockRange: 20000
└── minTrades: 100
```

#### Market Service（市场服务）

```
职责：
├── 调用 Gamma API
├── 解析市场元数据
├── 构建 tokenId → market 映射
└── 提供缓存和降级能力

缓存策略：
├── 内存缓存（运行时）
├── 文件缓存（持久化）
└── TTL: 1 小时
```

#### Trade Decoder（交易解码器）

```
职责：
├── ABI 解码 OrderFilled 事件
├── 识别 outcome tokenId
├── 判定交易方向 (BUY/SELL)
└── 计算成交价格

方向判定：
├── makerAssetId ∈ tokens → BUY
└── takerAssetId ∈ tokens → SELL

价格计算：
├── BUY:  takerAmount / makerAmount
└── SELL: makerAmount / takerAmount
```

---

## 3. 数据流

### 3.1 初始化流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                         初始化数据流                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Step 1: 获取市场数据                                                │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐         │
│  │ Gamma API   │ ───► │ Market      │ ───► │ SQLite      │         │
│  │             │      │ Service     │      │ (markets)   │         │
│  └─────────────┘      └──────┬──────┘      └─────────────┘         │
│                              │                                      │
│                              ▼                                      │
│                       TokenMapping                                  │
│                              │                                      │
│  Step 2: 获取交易数据         │                                      │
│  ┌─────────────┐      ┌──────┴──────┐      ┌─────────────┐         │
│  │ Polygon RPC │ ───► │ Indexer +   │ ───► │ SQLite      │         │
│  │ (eth_getLogs)│      │ Decoder     │      │ (trades)    │         │
│  └─────────────┘      └─────────────┘      └─────────────┘         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 运行时流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                         运行时数据流                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Browser                                                           │
│      │                                                              │
│      │  GET /api/trades?page=1&limit=20                             │
│      ▼                                                              │
│   ┌─────────────┐                                                   │
│   │ API Route   │                                                   │
│   │ Handler     │                                                   │
│   └──────┬──────┘                                                   │
│          │                                                          │
│          │  validateQuery(params)                                   │
│          ▼                                                          │
│   ┌─────────────┐                                                   │
│   │ Repository  │                                                   │
│   │ (Prisma)    │                                                   │
│   └──────┬──────┘                                                   │
│          │                                                          │
│          │  SELECT * FROM trades ...                                │
│          ▼                                                          │
│   ┌─────────────┐                                                   │
│   │ SQLite      │                                                   │
│   └──────┬──────┘                                                   │
│          │                                                          │
│          │  Result Set                                              │
│          ▼                                                          │
│   ┌─────────────┐                                                   │
│   │ JSON        │ ───► Browser ───► React Component                 │
│   │ Response    │                                                   │
│   └─────────────┘                                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 时序图

```
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│Browser │  │API     │  │Repo    │  │SQLite  │  │React   │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │           │
    │ Request   │           │           │           │
    │──────────►│           │           │           │
    │           │ Query     │           │           │
    │           │──────────►│           │           │
    │           │           │ SQL       │           │
    │           │           │──────────►│           │
    │           │           │           │           │
    │           │           │◄──────────│           │
    │           │           │ Rows      │           │
    │           │◄──────────│           │           │
    │           │ Data      │           │           │
    │◄──────────│           │           │           │
    │ JSON      │           │           │           │
    │           │           │           │           │
    │───────────────────────────────────────────────►│
    │           │           │           │  Render   │
    │           │           │           │           │
```

---

## 4. 技术选型

### 4.1 技术栈表格

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| **框架** | Next.js | 14+ | App Router, API Routes |
| **语言** | TypeScript | 5.x | 强类型 |
| **UI** | React | 18+ | 函数组件, Hooks |
| **样式** | Tailwind CSS | 3.x | 原子化 CSS |
| **图表** | Recharts | 2.x | React 图表库 |
| **数据库** | SQLite | - | 轻量级嵌入式 |
| **ORM** | Prisma | 5.x | 类型安全 ORM |
| **链上** | ethers.js | 6.x | 以太坊交互 |
| **校验** | Zod | 3.x | Schema 校验 |
| **状态** | React Query | 5.x | 服务端状态管理 |
| **日志** | Pino | 8.x | 高性能日志 |

### 4.2 选型理由

| 技术 | 选型理由 |
|------|----------|
| **Next.js** | 全栈框架，API Routes 无需单独后端 |
| **SQLite** | MVP 阶段足够，无需额外数据库服务 |
| **Prisma** | 类型安全，迁移方便，开发体验好 |
| **ethers.js** | 成熟稳定，ABI 解码能力强 |
| **React Query** | 自动缓存、重试、失效，减少样板代码 |
| **Tailwind** | 快速开发，无需编写 CSS 文件 |

---

## 5. 目录结构

```
polymarket-dashboard/
│
├── app/                          # Next.js App Router
│   ├── api/                      # API Routes
│   │   ├── trades/
│   │   │   └── route.ts          # GET /api/trades
│   │   ├── markets/
│   │   │   ├── route.ts          # GET /api/markets
│   │   │   └── [id]/
│   │   │       └── route.ts      # GET /api/markets/:id
│   │   ├── traders/
│   │   │   ├── route.ts          # GET /api/traders
│   │   │   └── [address]/
│   │   │       └── route.ts      # GET /api/traders/:address
│   │   └── tags/
│   │       └── route.ts          # POST/DELETE /api/tags
│   │
│   ├── components/               # React 组件
│   │   ├── trades/               # 交易相关组件
│   │   ├── markets/              # 市场相关组件
│   │   ├── traders/              # 交易者相关组件
│   │   └── common/               # 通用组件
│   │
│   ├── hooks/                    # 自定义 Hooks
│   │   ├── useTrades.ts
│   │   ├── useMarkets.ts
│   │   └── useTraders.ts
│   │
│   ├── page.tsx                  # 首页 Dashboard
│   └── layout.tsx                # 全局布局
│
├── lib/                          # 核心逻辑（后端）
│   ├── indexer.ts                # 链上索引器
│   ├── market-service.ts         # 市场服务
│   ├── trade-decoder.ts          # 交易解码
│   ├── repository.ts             # 数据存储
│   ├── rpc-client.ts             # RPC 客户端
│   ├── validators.ts             # 参数校验
│   └── logger.ts                 # 日志工具
│
├── types/                        # TypeScript 类型定义
│   ├── trade.ts
│   ├── market.ts
│   └── api.ts
│
├── prisma/                       # Prisma ORM
│   ├── schema.prisma             # 数据库 Schema
│   └── migrations/               # 迁移文件
│
├── scripts/                      # 脚本（所有启停操作）
│   ├── dev.sh                    # 开发服务器启动
│   ├── build.sh                  # 构建脚本
│   ├── fetch-data.sh             # 数据拉取脚本
│   └── migrate.sh                # 数据库迁移
│
├── logs/                         # 日志目录
│   └── app.log
│
├── data/                         # 缓存数据
│   └── markets-cache.json
│
├── docs/                         # 文档
│   └── test_plan/
│       ├── PRD.md
│       ├── TECHNICAL_DESIGN.md
│       └── ARCHITECTURE.md
│
├── .env.example                  # 环境变量示例
├── package.json
├── tsconfig.json
├── tailwind.config.ts
└── CLAUDE.md                     # 项目规范
```

### 文件数量限制

根据 CLAUDE.md 规范：

| 规则 | 限制 |
|------|------|
| JS/TS 文件行数 | ≤ 300 行 |
| 每层文件夹文件数 | ≤ 8 个 |

---

## 6. 部署架构

### 6.1 开发环境

```
┌─────────────────────────────────────────────────────────────┐
│                    Development Environment                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                  Local Machine                       │   │
│   │                                                     │   │
│   │   ┌─────────────┐   ┌─────────────┐                 │   │
│   │   │ Next.js Dev │   │ SQLite DB   │                 │   │
│   │   │ Server      │   │ (dev.db)    │                 │   │
│   │   │ :3000       │   │             │                 │   │
│   │   └──────┬──────┘   └──────┬──────┘                 │   │
│   │          │                 │                         │   │
│   │          └────────┬────────┘                         │   │
│   │                   │                                  │   │
│   │                   ▼                                  │   │
│   │          ┌─────────────┐                             │   │
│   │          │ Browser     │                             │   │
│   │          │ :3000       │                             │   │
│   │          └─────────────┘                             │   │
│   │                                                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   External:                                                 │
│   • Polygon RPC (公共节点)                                   │
│   • Gamma API (公共 API)                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 生产环境（MVP）

```
┌─────────────────────────────────────────────────────────────┐
│                    Production (MVP)                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Option A: Vercel                                          │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                                                     │   │
│   │   ┌─────────────┐   ┌─────────────┐                 │   │
│   │   │ Vercel Edge │   │ Turso/      │                 │   │
│   │   │ Functions   │   │ PlanetScale │                 │   │
│   │   └─────────────┘   └─────────────┘                 │   │
│   │                                                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   Option B: VPS (Railway/Render)                            │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                                                     │   │
│   │   ┌─────────────┐   ┌─────────────┐                 │   │
│   │   │ Node.js     │   │ SQLite      │                 │   │
│   │   │ Server      │   │ (Persistent)│                 │   │
│   │   └─────────────┘   └─────────────┘                 │   │
│   │                                                     │   │
│   │   ┌─────────────┐                                   │   │
│   │   │ Cron Job    │  (定时数据同步)                    │   │
│   │   └─────────────┘                                   │   │
│   │                                                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 部署选项对比

| 选项 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **Vercel** | 零配置、自动 HTTPS、CDN | 需换 SQLite | 演示、展示 |
| **Railway** | 持久化存储、简单 | 冷启动 | MVP 生产 |
| **VPS** | 完全控制 | 运维成本 | 长期运营 |

---

## 7. 安全模型

### 7.1 安全边界

```
┌─────────────────────────────────────────────────────────────┐
│                      Security Boundary                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ✅ 允许：                                                  │
│   • 只读 RPC 调用 (eth_getLogs, eth_blockNumber)            │
│   • 公开 API 调用 (Gamma Markets)                           │
│   • 数据展示和分析                                           │
│                                                             │
│   ❌ 禁止：                                                  │
│   • 无私钥存储                                               │
│   • 无交易签名                                               │
│   • 无资金操作                                               │
│   • 无用户敏感数据                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 安全措施

| 风险 | 措施 |
|------|------|
| API 滥用 | Rate Limiting（后续添加） |
| 数据泄露 | 无敏感数据存储 |
| 注入攻击 | Prisma 参数化查询 |
| XSS | React 自动转义 |

---

## 8. 异常处理

### 8.1 异常处理策略

```
┌─────────────────────────────────────────────────────────────┐
│                    Error Handling Strategy                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   RPC 失败                                                   │
│   └─► 指数退避重试（3 次）                                    │
│       └─► 失败后抛出异常                                      │
│                                                             │
│   Gamma API 失败                                             │
│   └─► 降级到本地缓存                                          │
│       └─► 无缓存时抛出异常                                    │
│                                                             │
│   数据解码失败                                                │
│   └─► 记录错误日志                                           │
│       └─► 跳过该条记录，继续处理                              │
│                                                             │
│   重复数据                                                   │
│   └─► DB 唯一约束拦截                                        │
│       └─► 静默忽略（幂等性）                                  │
│                                                             │
│   API 参数错误                                               │
│   └─► Zod 校验                                              │
│       └─► 返回 400 + 错误信息                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 重试配置

```typescript
const RETRY_CONFIG = {
  maxRetries: 3,
  baseDelay: 1000,      // 1s
  maxDelay: 10000,      // 10s
  backoffMultiplier: 2,
};
```

---

## 9. 设计原则

### 9.1 核心原则

| 原则 | 说明 | 实践 |
|------|------|------|
| **链即真相** | 链上数据为唯一可信来源 | 不信任外部 API 的交易数据 |
| **解码可验证** | 所有派生数据可追溯 | 保留原始 event 字段 |
| **指标可解释** | 计算逻辑透明 | 文档化 price/direction 公式 |
| **架构极简** | MVP 阶段避免过度设计 | 单体应用，SQLite |

### 9.2 代码规范

| 规范 | 要求 |
|------|------|
| 文件行数 | JS/TS ≤ 300 行 |
| 文件夹文件数 | ≤ 8 个 |
| 类型安全 | 强类型，避免 any |
| 启停脚本 | 统一使用 scripts/*.sh |
| 日志输出 | 输出到 logs/ 目录 |

---

## 10. 演进路线

### 10.1 当前架构（MVP）

```
┌─────────────────────────────────────────┐
│            MVP Architecture             │
├─────────────────────────────────────────┤
│                                         │
│   Next.js (全栈)                         │
│      │                                  │
│      ├── API Routes                     │
│      ├── React Components              │
│      └── SQLite (本地)                  │
│                                         │
│   特点：                                 │
│   • 单体架构                             │
│   • 批量数据同步                         │
│   • 无用户系统                           │
│                                         │
└─────────────────────────────────────────┘
```

### 10.2 未来架构（Phase 2+）

```
┌─────────────────────────────────────────────────────────────────┐
│                      Future Architecture                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐                                               │
│   │  Indexer    │ ─────────────────────┐                        │
│   │  Service    │                      │                        │
│   └─────────────┘                      ▼                        │
│                                  ┌───────────┐                  │
│   ┌─────────────┐                │PostgreSQL │                  │
│   │  WebSocket  │ ◄──────────────│           │                  │
│   │  Server     │                └─────┬─────┘                  │
│   └──────┬──────┘                      │                        │
│          │                             │                        │
│          ▼                             ▼                        │
│   ┌─────────────┐              ┌─────────────┐                  │
│   │  Real-time  │              │  Analytics  │                  │
│   │  Alerts     │              │  Engine     │                  │
│   └─────────────┘              └──────┬──────┘                  │
│                                       │                         │
│                                       ▼                         │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐          │
│   │    Web      │   │  Telegram   │   │     AI      │          │
│   │  Dashboard  │   │    Bot      │   │  Analysis   │          │
│   └─────────────┘   └─────────────┘   └─────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 10.3 演进阶段

| 阶段 | 功能 | 架构变化 |
|------|------|----------|
| **MVP** | 基础展示 | 单体 + SQLite |
| **Phase 2** | 实时推送、精准 PnL | + WebSocket |
| **Phase 3** | 用户系统、通知 | + Auth + Telegram |
| **Phase 4** | AI 分析、跟单 | + Analytics Engine |

---

## 附录

### A. 相关文档

- [PRD.md](./PRD.md) - 产品需求文档
- [TECHNICAL_DESIGN.md](./TECHNICAL_DESIGN.md) - 技术设计文档

### B. 参考资源

- [Next.js 文档](https://nextjs.org/docs)
- [Prisma 文档](https://www.prisma.io/docs)
- [Polymarket 文档](https://docs.polymarket.com/)
