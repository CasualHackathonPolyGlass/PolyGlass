# 模块D：TokenId → Market 归类器（Resolver）

**模块编号**：13
**版本**：v0.1

---

## 1. 目标

为每笔 trade 确定：

- `tokenId`（outcome token）
- `marketId`（所属市场）
- `outcomeSide`（YES/NO）
- `direction`（BUY/SELL）
- `price`（0~1）

---

## 2. 接口定义

### 输入

| 参数 | 类型 | 说明 |
|------|------|------|
| `decodedTrades` | DecodedTrade[] | 模块C产出 |
| `tokenMap` | Map<string, MarketMapping> | 模块A产出 |

### 输出

```typescript
interface ResolvedTrade extends DecodedTrade {
  // 归类字段
  tokenId: string;
  marketId: string | null;
  marketTitle: string | null;
  outcomeSide: 'YES' | 'NO' | null;
  direction: 'BUY' | 'SELL';
  price: number;

  // 标记
  isResolved: boolean;  // marketId 是否命中
}
```

---

## 3. 归类规则

### 3.1 TokenId 判定

```
规则优先级：
1. 如果 makerAssetId ∈ tokenMap → tokenId = makerAssetId
2. 否则如果 takerAssetId ∈ tokenMap → tokenId = takerAssetId
3. 否则 → tokenId = null（无法归类）
```

### 3.2 Market 归类

```typescript
if (tokenId && tokenMap.has(tokenId)) {
  const mapping = tokenMap.get(tokenId);
  marketId = mapping.marketId;
  outcomeSide = mapping.outcomeSide;
  isResolved = true;
} else {
  marketId = null;
  outcomeSide = null;
  isResolved = false;
}
```

### 3.3 Direction 判定

```
语义：
- 收到 outcome token → BUY（买入）
- 给出 outcome token → SELL（卖出）

判断逻辑：
- 如果 tokenId == makerAssetId
  → taker 收到 outcome token
  → direction = 'BUY'

- 如果 tokenId == takerAssetId
  → taker 给出 outcome token
  → direction = 'SELL'
```

### 3.4 Price 计算

```
公式：price = collateral / outcome_shares

BUY 情况：
  - taker 用 collateral 换 outcome
  - price = takerAmountFilled / makerAmountFilled

SELL 情况：
  - taker 用 outcome 换 collateral
  - price = makerAmountFilled / takerAmountFilled

结果归一化到 0~1 区间
```

---

## 4. 处理流程

```
┌─────────────────────────────────────────────────────────────┐
│                      归类流程                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   for each trade in decodedTrades:                          │
│      │                                                      │
│      ▼                                                      │
│   1. 判定 tokenId                                            │
│      tokenId = makerAssetId ∈ tokenMap                      │
│               ? makerAssetId                                │
│               : takerAssetId ∈ tokenMap                     │
│               ? takerAssetId                                │
│               : null                                        │
│      │                                                      │
│      ▼                                                      │
│   2. 查询 market 映射                                        │
│      if (tokenId) {                                         │
│        mapping = tokenMap.get(tokenId)                      │
│        marketId = mapping.marketId                          │
│        outcomeSide = mapping.outcomeSide                    │
│      }                                                      │
│      │                                                      │
│      ▼                                                      │
│   3. 判定 direction                                          │
│      direction = tokenId == makerAssetId                    │
│                ? 'BUY'                                      │
│                : 'SELL'                                     │
│      │                                                      │
│      ▼                                                      │
│   4. 计算 price                                              │
│      if (direction == 'BUY') {                              │
│        price = takerAmount / makerAmount                    │
│      } else {                                               │
│        price = makerAmount / takerAmount                    │
│      }                                                      │
│      │                                                      │
│      ▼                                                      │
│   5. 构建 ResolvedTrade                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 代码接口

```typescript
// lib/market-resolver.ts

interface ResolveConfig {
  tokenMap: Map<string, MarketMapping>;
  marketsMap: Map<string, Market>;  // 用于获取 title
}

// 解析单条交易
function resolveTrade(
  trade: DecodedTrade,
  config: ResolveConfig
): ResolvedTrade;

// 批量解析
function resolveTrades(
  trades: DecodedTrade[],
  config: ResolveConfig
): ResolvedTrade[];

// 计算价格
function calculatePrice(
  makerAmount: bigint,
  takerAmount: bigint,
  direction: 'BUY' | 'SELL'
): number {
  if (direction === 'BUY') {
    return Number(takerAmount) / Number(makerAmount);
  } else {
    return Number(makerAmount) / Number(takerAmount);
  }
}

// 价格校验
function validatePrice(price: number): boolean {
  return price >= 0 && price <= 1;
}
```

---

## 6. 异常处理

### Price 异常

| 情况 | 处理 |
|------|------|
| price < 0 | 标记异常，设为 0 |
| price > 1 | 标记异常，设为 1 |
| NaN/Infinity | 标记异常，设为 null |

### Market 未命中

```typescript
if (!isResolved) {
  // 记录未命中的 tokenId
  unknownTokenIds.add(tokenId);

  // 设置默认值
  marketId = null;
  marketTitle = `Unknown (${tokenId})`;
  outcomeSide = null;
}
```

---

## 7. 产物文件

| 文件 | 说明 |
|------|------|
| `data/resolved_trades.json` | 归类后的交易列表 |

### 文件格式示例

```json
{
  "totalResolved": 150,
  "resolvedCount": 142,
  "unresolvedCount": 8,
  "priceAnomalies": 2,
  "trades": [
    {
      "txHash": "0x1234...",
      "blockNumber": 55050000,
      "logIndex": 0,
      "orderHash": "0xabcd...",
      "maker": "0x1111...",
      "taker": "0x2222...",
      "makerAssetId": "12345",
      "takerAssetId": "0",
      "makerAmountFilled": "1000000000000000000",
      "takerAmountFilled": "650000000",
      "fee": "1000000",
      "tokenId": "12345",
      "marketId": "0x5678...",
      "marketTitle": "Will X happen?",
      "outcomeSide": "YES",
      "direction": "BUY",
      "price": 0.65,
      "isResolved": true
    }
  ]
}
```

---

## 8. 验收标准

- [ ] 输出 `data/resolved_trades.json`
- [ ] resolved trades 中 marketId 命中率 > 80%
- [ ] price 在 0~1 区间（异常记录已标记）
- [ ] 每条 trade 有 direction 字段
- [ ] 每条 trade 有 tokenId 字段
