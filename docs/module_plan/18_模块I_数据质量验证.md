# æ¨¡å—Iï¼šæ•°æ®è´¨é‡ä¸éªŒè¯

**æ¨¡å—ç¼–å·**ï¼š18
**ç‰ˆæœ¬**ï¼šv0.1

---

## 1. ç›®æ ‡

ç¡®ä¿æ•°æ®è´¨é‡ï¼ŒéªŒè¯é“¾ä¸Šæ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚

---

## 2. å¿…é¡»éªŒè¯é¡¹

| éªŒè¯é¡¹ | æ ‡å‡† | éªŒè¯æ–¹å¼ |
|--------|------|----------|
| äº¤æ˜“æ•°é‡ | trades â‰¥ 100 | æ•°æ®åº“æŸ¥è¯¢ |
| txHash å¯è¿½æº¯ | æ¯æ¡ trade æœ‰æœ‰æ•ˆ txHash | å­—æ®µæ ¡éªŒ |
| è§£ç å­—æ®µå®Œæ•´ | maker/taker/amount ä¸ä¸ºç©º | å­—æ®µæ ¡éªŒ |
| ä»·æ ¼åˆç† | 0 â‰¤ price â‰¤ 1 | èŒƒå›´æ ¡éªŒ |
| Market å‘½ä¸­ç‡ | > 80% | ç»Ÿè®¡è®¡ç®— |

---

## 3. éªŒè¯æ£€æŸ¥ç‚¹

### 3.1 æ•°æ®é‡æ£€æŸ¥

```typescript
// scripts/validate.ts

async function validateTradeCount(): Promise<ValidationResult> {
  const count = await prisma.trade.count();

  return {
    name: 'Trade Count',
    passed: count >= 100,
    expected: '>= 100',
    actual: count,
    message: count >= 100
      ? `âœ… Found ${count} trades`
      : `âŒ Only ${count} trades, need at least 100`,
  };
}
```

### 3.2 å­—æ®µå®Œæ•´æ€§æ£€æŸ¥

```typescript
async function validateFieldCompleteness(): Promise<ValidationResult> {
  const incomplete = await prisma.trade.count({
    where: {
      OR: [
        { txHash: { equals: '' } },
        { maker: { equals: '' } },
        { taker: { equals: '' } },
        { direction: { equals: '' } },
      ]
    }
  });

  return {
    name: 'Field Completeness',
    passed: incomplete === 0,
    expected: '0 incomplete records',
    actual: incomplete,
    message: incomplete === 0
      ? 'âœ… All fields complete'
      : `âŒ ${incomplete} records have empty fields`,
  };
}
```

### 3.3 ä»·æ ¼èŒƒå›´æ£€æŸ¥

```typescript
async function validatePriceRange(): Promise<ValidationResult> {
  const anomalies = await prisma.trade.count({
    where: {
      OR: [
        { price: { lt: 0 } },
        { price: { gt: 1 } },
        { price: null },
      ]
    }
  });

  const total = await prisma.trade.count();
  const anomalyRate = anomalies / total;

  return {
    name: 'Price Range',
    passed: anomalyRate < 0.05,  // å…è®¸ 5% å¼‚å¸¸
    expected: '< 5% anomalies',
    actual: `${(anomalyRate * 100).toFixed(2)}%`,
    message: anomalyRate < 0.05
      ? `âœ… ${anomalies} price anomalies (${(anomalyRate * 100).toFixed(2)}%)`
      : `âŒ Too many price anomalies: ${anomalies}`,
  };
}
```

### 3.4 Market å‘½ä¸­ç‡æ£€æŸ¥

```typescript
async function validateMarketResolution(): Promise<ValidationResult> {
  const resolved = await prisma.trade.count({
    where: { isResolved: true }
  });
  const total = await prisma.trade.count();
  const hitRate = resolved / total;

  return {
    name: 'Market Resolution',
    passed: hitRate > 0.8,
    expected: '> 80%',
    actual: `${(hitRate * 100).toFixed(2)}%`,
    message: hitRate > 0.8
      ? `âœ… Market hit rate: ${(hitRate * 100).toFixed(2)}%`
      : `âŒ Low market hit rate: ${(hitRate * 100).toFixed(2)}%`,
  };
}
```

### 3.5 txHash æ ¼å¼æ£€æŸ¥

```typescript
async function validateTxHashFormat(): Promise<ValidationResult> {
  const trades = await prisma.trade.findMany({
    select: { txHash: true },
    take: 100,
  });

  const txHashRegex = /^0x[a-fA-F0-9]{64}$/;
  const invalid = trades.filter(t => !txHashRegex.test(t.txHash));

  return {
    name: 'TxHash Format',
    passed: invalid.length === 0,
    expected: 'All valid 0x format',
    actual: `${invalid.length} invalid`,
    message: invalid.length === 0
      ? 'âœ… All txHash valid'
      : `âŒ ${invalid.length} invalid txHash found`,
  };
}
```

---

## 4. å¸¸è§é—®é¢˜æ’æŸ¥

### 4.1 RPC è¿”å›ç©º

| å¯èƒ½åŸå›  | æ’æŸ¥æ–¹æ³• | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| çª—å£å¤ªå° | æ£€æŸ¥ blockRange é…ç½® | å¢å¤§åˆ° 50000 |
| èµ·ç‚¹å¤ªæ–° | æ£€æŸ¥ fromBlock | ä½¿ç”¨ latest |
| åˆçº¦åœ°å€é”™è¯¯ | éªŒè¯åˆçº¦åœ°å€ | ä½¿ç”¨æ­£ç¡®åœ°å€ |
| RPC é™æµ | æ£€æŸ¥é”™è¯¯æ—¥å¿— | ä½¿ç”¨ä»˜è´¹ RPC |

### 4.2 è§£ç å¤±è´¥

| å¯èƒ½åŸå›  | æ’æŸ¥æ–¹æ³• | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| ABI ä¸åŒ¹é… | å¯¹æ¯”äº‹ä»¶ç­¾å | æ›´æ–° ABI |
| åˆçº¦ç‰ˆæœ¬ | æ£€æŸ¥åˆçº¦åœ°å€ | æ·»åŠ å¤šç‰ˆæœ¬æ”¯æŒ |
| æ•°æ®æŸå | æ£€æŸ¥åŸå§‹ log | è·³è¿‡å¼‚å¸¸è®°å½• |

### 4.3 Market å‘½ä¸­ç‡ä½

| å¯èƒ½åŸå›  | æ’æŸ¥æ–¹æ³• | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| Markets æœªæ‹‰å…¨ | æ£€æŸ¥ Gamma è¯·æ±‚ | å¢åŠ åˆ†é¡µ/limit |
| TokenId ä¸åŒ¹é… | æ‰“å°æœªå‘½ä¸­ tokenId | æ£€æŸ¥æ˜ å°„é€»è¾‘ |
| æ—§å¸‚åœºå·²ä¸‹æ¶ | æ£€æŸ¥ active çŠ¶æ€ | åŒ…å«é active |

---

## 5. éªŒè¯è„šæœ¬

### å®Œæ•´éªŒè¯æµç¨‹

```typescript
// scripts/validate.ts

interface ValidationResult {
  name: string;
  passed: boolean;
  expected: string;
  actual: string | number;
  message: string;
}

async function runValidation(): Promise<void> {
  console.log('ğŸ” Running data validation...\n');

  const checks = [
    validateTradeCount,
    validateFieldCompleteness,
    validatePriceRange,
    validateMarketResolution,
    validateTxHashFormat,
  ];

  const results: ValidationResult[] = [];

  for (const check of checks) {
    const result = await check();
    results.push(result);
    console.log(`${result.passed ? 'âœ…' : 'âŒ'} ${result.name}`);
    console.log(`   Expected: ${result.expected}`);
    console.log(`   Actual: ${result.actual}`);
    console.log(`   ${result.message}\n`);
  }

  const passed = results.filter(r => r.passed).length;
  const total = results.length;

  console.log('â”€'.repeat(50));
  console.log(`\nğŸ“Š Validation Summary: ${passed}/${total} checks passed`);

  if (passed < total) {
    console.log('\nâš ï¸  Some checks failed. Please review and fix.');
    process.exit(1);
  } else {
    console.log('\nğŸ‰ All checks passed!');
  }
}

runValidation().catch(console.error);
```

### è¿è¡Œå‘½ä»¤

```bash
pnpm validate
# æˆ–
npx ts-node scripts/validate.ts
```

---

## 6. éªŒè¯æŠ¥å‘Šç¤ºä¾‹

```
ğŸ” Running data validation...

âœ… Trade Count
   Expected: >= 100
   Actual: 150
   âœ… Found 150 trades

âœ… Field Completeness
   Expected: 0 incomplete records
   Actual: 0
   âœ… All fields complete

âœ… Price Range
   Expected: < 5% anomalies
   Actual: 1.33%
   âœ… 2 price anomalies (1.33%)

âœ… Market Resolution
   Expected: > 80%
   Actual: 94.67%
   âœ… Market hit rate: 94.67%

âœ… TxHash Format
   Expected: All valid 0x format
   Actual: 0 invalid
   âœ… All txHash valid

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“Š Validation Summary: 5/5 checks passed

ğŸ‰ All checks passed!
```

---

## 7. éªŒæ”¶æ ‡å‡†

- [ ] è¿è¡Œ `pnpm validate` å…¨éƒ¨é€šè¿‡
- [ ] trades æ•°é‡ â‰¥ 100
- [ ] æ¯æ¡ trade å¯è¿½æº¯ txHash
- [ ] è§£ç å­—æ®µä¸ä¸ºç©º
- [ ] ä»·æ ¼å¼‚å¸¸è®°å½•å·²æ ‡è®°
