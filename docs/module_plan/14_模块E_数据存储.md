# 模块E：SQLite 数据存储

**模块编号**：14
**版本**：v0.1

---

## 1. 目标

将 markets 与 resolved trades 持久化到 SQLite，支持查询与去重。

---

## 2. 表结构

### 2.1 markets 表

```sql
CREATE TABLE markets (
  id            TEXT PRIMARY KEY,      -- marketId
  title         TEXT NOT NULL,
  condition_id  TEXT NOT NULL,
  token_yes     TEXT NOT NULL,
  token_no      TEXT NOT NULL,
  active        INTEGER DEFAULT 1,     -- boolean
  created_at    TEXT DEFAULT (datetime('now')),
  updated_at    TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_markets_condition ON markets(condition_id);
```

### 2.2 trades 表

```sql
CREATE TABLE trades (
  id                    INTEGER PRIMARY KEY AUTOINCREMENT,
  tx_hash               TEXT NOT NULL,
  log_index             INTEGER NOT NULL,
  block_number          INTEGER NOT NULL,
  timestamp             TEXT,
  order_hash            TEXT NOT NULL,
  maker                 TEXT NOT NULL,
  taker                 TEXT NOT NULL,
  maker_asset_id        TEXT NOT NULL,
  taker_asset_id        TEXT NOT NULL,
  maker_amount_filled   TEXT NOT NULL,
  taker_amount_filled   TEXT NOT NULL,
  fee                   TEXT NOT NULL,
  token_id              TEXT,
  market_id             TEXT,
  outcome_side          TEXT,          -- 'YES' | 'NO'
  direction             TEXT NOT NULL, -- 'BUY' | 'SELL'
  price                 REAL,
  is_resolved           INTEGER DEFAULT 0,

  UNIQUE(tx_hash, log_index),
  FOREIGN KEY (market_id) REFERENCES markets(id)
);

CREATE INDEX idx_trades_maker ON trades(maker);
CREATE INDEX idx_trades_taker ON trades(taker);
CREATE INDEX idx_trades_token ON trades(token_id);
CREATE INDEX idx_trades_market ON trades(market_id);
CREATE INDEX idx_trades_block ON trades(block_number DESC);
CREATE INDEX idx_trades_timestamp ON trades(timestamp DESC);
```

### 2.3 address_tags 表

```sql
CREATE TABLE address_tags (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  address     TEXT NOT NULL,
  tag         TEXT NOT NULL,
  source      TEXT DEFAULT 'manual',  -- 'manual' | 'auto'
  created_at  TEXT DEFAULT (datetime('now')),

  UNIQUE(address, tag)
);

CREATE INDEX idx_tags_address ON address_tags(address);
CREATE INDEX idx_tags_tag ON address_tags(tag);
```

---

## 3. Prisma Schema（可选）

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Market {
  id          String   @id
  title       String
  conditionId String   @map("condition_id")
  tokenYes    String   @map("token_yes")
  tokenNo     String   @map("token_no")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  trades      Trade[]

  @@index([conditionId])
  @@map("markets")
}

model Trade {
  id                Int      @id @default(autoincrement())
  txHash            String   @map("tx_hash")
  logIndex          Int      @map("log_index")
  blockNumber       Int      @map("block_number")
  timestamp         DateTime?
  orderHash         String   @map("order_hash")
  maker             String
  taker             String
  makerAssetId      String   @map("maker_asset_id")
  takerAssetId      String   @map("taker_asset_id")
  makerAmountFilled String   @map("maker_amount_filled")
  takerAmountFilled String   @map("taker_amount_filled")
  fee               String
  tokenId           String?  @map("token_id")
  marketId          String?  @map("market_id")
  outcomeSide       String?  @map("outcome_side")
  direction         String
  price             Float?
  isResolved        Boolean  @default(false) @map("is_resolved")

  market            Market?  @relation(fields: [marketId], references: [id])

  @@unique([txHash, logIndex])
  @@index([maker])
  @@index([taker])
  @@index([tokenId])
  @@index([marketId])
  @@index([blockNumber])
  @@map("trades")
}

model AddressTag {
  id        Int      @id @default(autoincrement())
  address   String
  tag       String
  source    String   @default("manual")
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([address, tag])
  @@index([address])
  @@index([tag])
  @@map("address_tags")
}
```

---

## 4. 去重策略

### 唯一约束

```sql
UNIQUE(tx_hash, log_index)
```

### 写入策略

```typescript
// INSERT OR IGNORE（冲突时跳过）
async function insertTrades(trades: ResolvedTrade[]): Promise<number> {
  let inserted = 0;
  for (const trade of trades) {
    try {
      await db.trade.create({ data: trade });
      inserted++;
    } catch (error) {
      if (error.code === 'P2002') {
        // 唯一约束冲突，跳过
        continue;
      }
      throw error;
    }
  }
  return inserted;
}
```

---

## 5. 写入流程

```
┌─────────────────────────────────────────────────────────────┐
│                      写入流程                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 写入 markets（upsert）                                  │
│      for each market:                                       │
│        INSERT OR REPLACE INTO markets ...                   │
│      │                                                      │
│      ▼                                                      │
│   2. 写入 trades（insert, 冲突跳过）                          │
│      for each trade:                                        │
│        INSERT OR IGNORE INTO trades ...                     │
│      │                                                      │
│      ▼                                                      │
│   3. 返回统计                                                │
│      { insertedMarkets, insertedTrades, skippedDuplicates } │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 代码接口

```typescript
// lib/repository.ts

// Markets
async function upsertMarkets(markets: Market[]): Promise<number>;
async function getMarkets(options?: QueryOptions): Promise<Market[]>;
async function getMarketById(id: string): Promise<Market | null>;

// Trades
async function insertTrades(trades: ResolvedTrade[]): Promise<number>;
async function getTrades(options?: TradeQueryOptions): Promise<Trade[]>;
async function getTradeCount(): Promise<number>;

// Address Tags
async function addTag(address: string, tag: string): Promise<void>;
async function removeTag(address: string, tag: string): Promise<void>;
async function getTagsByAddress(address: string): Promise<AddressTag[]>;

// 统计查询
async function getMarketStats(): Promise<MarketStats[]>;
async function getTraderStats(): Promise<TraderStats[]>;
```

---

## 7. 环境变量

```bash
# .env
DATABASE_URL=file:./data/app.db
```

---

## 8. 迁移命令

```bash
# Prisma
pnpm prisma migrate dev --name init
pnpm prisma generate

# 或纯 SQL
sqlite3 ./data/app.db < migrations/001_init.sql
```

---

## 9. 产物文件

| 文件 | 说明 |
|------|------|
| `data/app.db` | SQLite 数据库文件 |
| `prisma/migrations/` | 迁移历史 |

---

## 10. 验收标准

- [ ] SQLite 文件存在（`data/app.db`）
- [ ] `markets` 表有数据
- [ ] `trades` 表行数 ≥ 100
- [ ] 唯一约束生效（重复写入不报错）
- [ ] 索引已创建
