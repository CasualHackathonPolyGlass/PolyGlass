# 模块拆分与接口总览

**版本**：v0.1 (MVP)
**时间**：2026-01

---

## 1. 数据流水线（从链到页面）

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Data Pipeline                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   A. Gamma 元数据                                                   │
│      │                                                              │
│      ▼                                                              │
│   B. RPC 扫描 logs ───► C. 解码 OrderFilled                         │
│                              │                                      │
│                              ▼                                      │
│                         D. tokenId 归类 market                      │
│                              │                                      │
│                              ▼                                      │
│                         E. 写入 SQLite                              │
│                              │                                      │
│                              ▼                                      │
│                         F. API 聚合查询                              │
│                              │                                      │
│                              ▼                                      │
│                         G. 前端展示                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 模块接口（输入/输出）

| 模块 | 输入 | 输出 | 依赖 |
|------|------|------|------|
| **A. Gamma** | GAMMA_API_URL | tokenId → market 映射表 | - |
| **B. Scanner** | RPC_URL, 合约地址 | 原始 logs（txHash/block/topics/data） | - |
| **C. Decoder** | 原始 logs, ABI | 结构化 trade（maker/taker/amount/fee） | B |
| **D. Resolver** | decoded trades, tokenMap | trade + marketId + direction + price | A, C |
| **E. Storage** | resolved trades, markets | SQLite 持久化 | A, D |
| **F. API** | HTTP Request | JSON Response | E |
| **G. Dashboard** | API Data | Web UI | F |

---

## 3. 模块详细说明

### A. Gamma 元数据服务

```
输入：
  - GAMMA_API_BASE (https://gamma-api.polymarket.com)
  - 查询条件 (active=true)

输出：
  - markets 表数据
  - tokenId -> marketId 映射
  - tokenId -> outcomeSide(YES/NO) 映射

产物文件：
  - data/markets.json
  - data/tokenMap.json
```

### B. RPC 日志扫描器

```
输入：
  - RPC_URL
  - 合约地址列表
  - 扫描窗口大小 (20,000 blocks)

输出：
  - 原始 logs 列表
  - 每条含：blockNumber, txHash, logIndex, topics, data

产物文件：
  - data/logs_orderfilled.json
```

### C. OrderFilled 解码器

```
输入：
  - 原始 logs (模块B)
  - OrderFilled ABI

输出：
  - orderHash, maker, taker
  - makerAssetId, takerAssetId
  - makerAmountFilled, takerAmountFilled
  - fee, txHash, blockNumber, logIndex

产物文件：
  - data/decoded_trades.json
```

### D. Market 归类器

```
输入：
  - decoded trades (模块C)
  - tokenMap (模块A)

输出：
  - tokenId, marketId, outcomeSide
  - direction (BUY/SELL)
  - price (0~1)

产物文件：
  - data/resolved_trades.json
```

### E. SQLite 存储

```
输入：
  - markets (模块A)
  - resolved trades (模块D)

输出：
  - SQLite 数据库文件

表结构：
  - markets
  - trades
  - address_tags
```

### F. HTTP API

```
输入：
  - HTTP Request

输出：
  - JSON Response

端点：
  - GET /api/trades
  - GET /api/markets
  - GET /api/traders
  - POST /api/tags
```

### G. 前端 Dashboard

```
输入：
  - API 数据

输出：
  - Web UI 页面

组件：
  - Trades Table
  - Markets Chart
  - Price Line
  - Traders Leaderboard
```

---

## 4. 数据流转示意

```
Gamma API                    Polygon RPC
    │                            │
    ▼                            ▼
┌─────────┐                ┌─────────┐
│ Module  │                │ Module  │
│    A    │                │    B    │
└────┬────┘                └────┬────┘
     │                          │
     │  tokenMap                │  raw logs
     │                          ▼
     │                    ┌─────────┐
     │                    │ Module  │
     │                    │    C    │
     │                    └────┬────┘
     │                         │
     │  decoded trades         │
     │                         ▼
     └────────────────►  ┌─────────┐
                         │ Module  │
                         │    D    │
                         └────┬────┘
                              │
                              │  resolved trades
                              ▼
                         ┌─────────┐
                         │ Module  │
                         │    E    │
                         └────┬────┘
                              │
                              │  SQLite
                              ▼
                         ┌─────────┐
                         │ Module  │
                         │    F    │
                         └────┬────┘
                              │
                              │  JSON API
                              ▼
                         ┌─────────┐
                         │ Module  │
                         │    G    │
                         └─────────┘
```

---

## 5. 文件产物清单

| 阶段 | 文件 | 说明 |
|------|------|------|
| A | `data/markets.json` | 市场元数据 |
| A | `data/tokenMap.json` | Token 映射 |
| B | `data/logs_orderfilled.json` | 原始日志 |
| C | `data/decoded_trades.json` | 解码交易 |
| D | `data/resolved_trades.json` | 归类交易 |
| E | `data/app.db` | SQLite 数据库 |
