# 模块H：地址标签系统（加分项）

**模块编号**：17
**版本**：v0.1
**优先级**：加分项（非必须）

---

## 1. 目标

支持手动给地址打标签，并在前端显示。

---

## 2. 功能说明

### 标签类型

| 类型 | 来源 | 说明 |
|------|------|------|
| 手动标签 | 用户操作 | 通过 API 添加 |
| 自动标签 | 系统规则 | 基于交易行为自动打标（后续） |

### 预设标签

| 标签 | 说明 | 规则（自动） |
|------|------|-------------|
| Whale | 大户 | 单笔 > 1000 USDC |
| Arb | 套利者 | 5分钟内反向交易 ≥2 |
| Trend | 趋势跟随 | 价格波动时加仓 |
| VIP | 重要地址 | 手动标记 |

---

## 3. API 设计

### POST /api/tags

添加标签。

#### 请求

```json
{
  "address": "0x1234567890abcdef1234567890abcdef12345678",
  "tag": "Whale"
}
```

#### 响应

```json
{
  "success": true,
  "data": {
    "id": 1,
    "address": "0x1234...",
    "tag": "Whale",
    "source": "manual",
    "createdAt": "2026-01-15T10:30:00Z"
  }
}
```

### GET /api/tags

获取地址标签。

#### 请求参数

| 参数 | 类型 | 说明 |
|------|------|------|
| address | string | 可选，按地址筛选 |

#### 响应

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "address": "0x1234...",
      "tag": "Whale",
      "source": "manual",
      "createdAt": "2026-01-15T10:30:00Z"
    }
  ]
}
```

### DELETE /api/tags

删除标签。

#### 请求参数

| 参数 | 类型 | 说明 |
|------|------|------|
| address | string | 必填 |
| tag | string | 必填 |

---

## 4. 数据库表

```sql
CREATE TABLE address_tags (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  address     TEXT NOT NULL,
  tag         TEXT NOT NULL,
  source      TEXT DEFAULT 'manual',  -- 'manual' | 'auto'
  created_at  TEXT DEFAULT (datetime('now')),

  UNIQUE(address, tag)
);

CREATE INDEX idx_tags_address ON address_tags(address);
```

---

## 5. 前端展示

### Top Traders 表格中的标签

```tsx
// components/traders/TagChip.tsx
interface TagChipProps {
  tag: string;
  onRemove?: () => void;
}

function TagChip({ tag, onRemove }: TagChipProps) {
  const colors = {
    Whale: 'bg-blue-100 text-blue-800',
    Arb: 'bg-purple-100 text-purple-800',
    Trend: 'bg-green-100 text-green-800',
    VIP: 'bg-yellow-100 text-yellow-800',
  };

  return (
    <span className={cn(
      'px-2 py-1 rounded-full text-xs font-medium',
      colors[tag] || 'bg-gray-100 text-gray-800'
    )}>
      {tag}
      {onRemove && (
        <button onClick={onRemove} className="ml-1">×</button>
      )}
    </span>
  );
}
```

### 添加标签对话框

```tsx
// components/traders/AddTagDialog.tsx
interface AddTagDialogProps {
  address: string;
  onSubmit: (tag: string) => void;
  onClose: () => void;
}

function AddTagDialog({ address, onSubmit, onClose }: AddTagDialogProps) {
  const [tag, setTag] = useState('');

  return (
    <Dialog open onClose={onClose}>
      <DialogTitle>Add Tag</DialogTitle>
      <DialogContent>
        <p>Address: {truncateAddress(address)}</p>
        <input
          value={tag}
          onChange={(e) => setTag(e.target.value)}
          placeholder="Enter tag name"
        />
      </DialogContent>
      <DialogActions>
        <button onClick={onClose}>Cancel</button>
        <button onClick={() => onSubmit(tag)}>Add</button>
      </DialogActions>
    </Dialog>
  );
}
```

---

## 6. 代码实现

### API Route Handler

```typescript
// app/api/tags/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function POST(request: NextRequest) {
  const { address, tag } = await request.json();

  // 校验
  if (!address || !tag) {
    return NextResponse.json({
      success: false,
      error: { code: 'INVALID_PARAMS', message: 'Missing address or tag' }
    }, { status: 400 });
  }

  try {
    const result = await prisma.addressTag.create({
      data: { address, tag, source: 'manual' }
    });

    return NextResponse.json({ success: true, data: result });
  } catch (error) {
    if (error.code === 'P2002') {
      return NextResponse.json({
        success: false,
        error: { code: 'DUPLICATE', message: 'Tag already exists' }
      }, { status: 409 });
    }
    throw error;
  }
}

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const address = searchParams.get('address');

  const tags = await prisma.addressTag.findMany({
    where: address ? { address } : undefined,
    orderBy: { createdAt: 'desc' },
  });

  return NextResponse.json({ success: true, data: tags });
}

export async function DELETE(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const address = searchParams.get('address');
  const tag = searchParams.get('tag');

  if (!address || !tag) {
    return NextResponse.json({
      success: false,
      error: { code: 'INVALID_PARAMS', message: 'Missing address or tag' }
    }, { status: 400 });
  }

  await prisma.addressTag.delete({
    where: { address_tag: { address, tag } }
  });

  return NextResponse.json({ success: true });
}
```

---

## 7. 验收标准

- [ ] POST /api/tags 能添加标签
- [ ] GET /api/tags?address=0x... 能查询标签
- [ ] 新增标签后刷新页面仍存在（来自 SQLite）
- [ ] Top Traders 表格地址旁显示 tag chips
- [ ] 重复添加返回 409 错误
