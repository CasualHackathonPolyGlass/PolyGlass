# 模块A：市场元数据服务（Gamma）

**模块编号**：10
**版本**：v0.1

---

## 1. 目标

从 Gamma API 拉取 Polymarket 市场元数据，构建 outcome tokenId 到 market 的映射。

---

## 2. 接口定义

### 输入

| 参数 | 类型 | 说明 |
|------|------|------|
| `GAMMA_API_BASE` | string | 默认 `https://gamma-api.polymarket.com` |
| `active` | boolean | 查询条件，默认 `true` |
| `limit` | number | 分页大小（MVP 可拉最近 N 个） |

### 输出（核心产物）

```typescript
// markets 表数据
interface Market {
  marketId: string;
  title: string;
  conditionId: string;
  tokenYes: string;
  tokenNo: string;
  active: boolean;
}

// 内存映射
type TokenMap = Map<string, {
  marketId: string;
  outcomeSide: 'YES' | 'NO';
}>;
```

---

## 3. Gamma API 说明

### 端点

```
GET https://gamma-api.polymarket.com/markets
```

### 请求参数

| 参数 | 说明 |
|------|------|
| `active` | true/false |
| `limit` | 返回数量 |
| `offset` | 分页偏移 |

### 响应示例

```json
[
  {
    "id": "0x1234...",
    "question": "Will X happen by 2026?",
    "conditionId": "0xabcd...",
    "clobTokenIds": ["12345", "67890"],
    "outcomes": ["Yes", "No"],
    "active": true
  }
]
```

---

## 4. 处理流程

```
┌─────────────────────────────────────────────────────────────┐
│                   Gamma 数据处理流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 请求 Gamma API                                         │
│      │                                                      │
│      ▼                                                      │
│   2. 解析响应 JSON                                           │
│      │                                                      │
│      ▼                                                      │
│   3. 提取字段：                                              │
│      • marketId = id                                        │
│      • title = question                                     │
│      • tokenYes = clobTokenIds[0]                          │
│      • tokenNo = clobTokenIds[1]                           │
│      │                                                      │
│      ▼                                                      │
│   4. 构建 TokenMap：                                         │
│      • tokenYes → { marketId, outcomeSide: 'YES' }         │
│      • tokenNo → { marketId, outcomeSide: 'NO' }           │
│      │                                                      │
│      ▼                                                      │
│   5. 写入文件/缓存                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 代码接口

```typescript
// lib/market-service.ts

interface GammaMarket {
  id: string;
  question: string;
  conditionId: string;
  clobTokenIds: string[];
  outcomes: string[];
  active: boolean;
}

interface MarketMapping {
  marketId: string;
  outcomeSide: 'YES' | 'NO';
}

// 获取市场列表
async function fetchMarkets(): Promise<GammaMarket[]>;

// 构建 Token 映射
function buildTokenMapping(markets: GammaMarket[]): Map<string, MarketMapping>;

// 保存到文件
async function saveMarketsToFile(markets: GammaMarket[]): Promise<void>;
async function saveTokenMapToFile(tokenMap: Map<string, MarketMapping>): Promise<void>;
```

---

## 6. 失败与降级

| 场景 | 处理策略 |
|------|----------|
| Gamma 请求超时 | 重试 3 次，指数退避 |
| Gamma 请求失败 | 使用本地缓存 `data/markets.json` |
| 无缓存且请求失败 | 抛出异常，中止流程 |

### 降级代码

```typescript
async function getMarketsWithFallback(): Promise<GammaMarket[]> {
  try {
    const markets = await fetchMarkets();
    await saveMarketsToFile(markets);  // 更新缓存
    return markets;
  } catch (error) {
    console.warn('Gamma API failed, using cache');
    return loadMarketsFromCache();
  }
}
```

---

## 7. 产物文件

| 文件 | 说明 |
|------|------|
| `data/markets.json` | 市场元数据列表 |
| `data/tokenMap.json` | tokenId → market 映射 |

### 文件格式示例

**markets.json**
```json
[
  {
    "marketId": "0x1234...",
    "title": "Will X happen?",
    "conditionId": "0xabcd...",
    "tokenYes": "12345",
    "tokenNo": "67890",
    "active": true
  }
]
```

**tokenMap.json**
```json
{
  "12345": { "marketId": "0x1234...", "outcomeSide": "YES" },
  "67890": { "marketId": "0x1234...", "outcomeSide": "NO" }
}
```

---

## 8. 验收标准

- [ ] 能成功请求 Gamma API
- [ ] 生成 `data/tokenMap.json` 文件
- [ ] tokenMap 中 tokenId 数量 > 0
- [ ] 每个 tokenId 有对应的 marketId 和 outcomeSide
