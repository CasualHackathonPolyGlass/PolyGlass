# 模块接口与 Schema 定义

**版本**：v0.1
**时间**：2026-01

---

## 目录

1. [通用类型定义](#1-通用类型定义)
2. [模块A - Market Service](#2-模块a---market-service)
3. [模块B - Scanner](#3-模块b---scanner)
4. [模块C - Decoder](#4-模块c---decoder)
5. [模块D - Resolver](#5-模块d---resolver)
6. [模块E - Repository](#6-模块e---repository)
7. [模块F - API](#7-模块f---api)
8. [模块G - Frontend](#8-模块g---frontend)
9. [Prisma Schema](#9-prisma-schema)
10. [Zod Validation Schema](#10-zod-validation-schema)

---

## 1. 通用类型定义

### types/common.ts

```typescript
// ============================================
// 基础类型
// ============================================

/** 以太坊地址 */
export type Address = `0x${string}`;

/** 交易哈希 */
export type TxHash = `0x${string}`;

/** bytes32 哈希 */
export type Bytes32 = `0x${string}`;

/** 区块号 */
export type BlockNumber = number;

/** 时间戳（ISO 8601 格式） */
export type Timestamp = string;

/** 大数字符串（用于 uint256） */
export type BigIntString = string;

// ============================================
// 枚举类型
// ============================================

/** 交易方向 */
export type Direction = 'BUY' | 'SELL';

/** Outcome 类型 */
export type OutcomeSide = 'YES' | 'NO';

/** 标签来源 */
export type TagSource = 'manual' | 'auto';

// ============================================
// 分页类型
// ============================================

export interface Pagination {
  limit: number;
  offset: number;
  total: number;
  hasMore: boolean;
}

export interface PaginationParams {
  limit?: number;
  offset?: number;
}

// ============================================
// API 响应类型
// ============================================

export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: ApiError;
  pagination?: Pagination;
}

export interface ApiError {
  code: string;
  message: string;
}

// 错误码枚举
export const ErrorCodes = {
  INVALID_PARAMS: 'INVALID_PARAMS',
  NOT_FOUND: 'NOT_FOUND',
  DUPLICATE: 'DUPLICATE',
  INTERNAL_ERROR: 'INTERNAL_ERROR',
} as const;

export type ErrorCode = typeof ErrorCodes[keyof typeof ErrorCodes];
```

---

## 2. 模块A - Market Service

### types/market.ts

```typescript
import { Address, OutcomeSide } from './common';

// ============================================
// Gamma API 响应类型
// ============================================

/** Gamma API 返回的市场数据 */
export interface GammaMarketResponse {
  id: string;
  question: string;
  conditionId: string;
  slug: string;
  resolutionSource: string;
  endDate: string;
  liquidity: string;
  startDate: string;
  image: string;
  icon: string;
  description: string;
  outcomes: string[];
  outcomePrices: string[];
  volume: string;
  active: boolean;
  closed: boolean;
  marketMakerAddress: string;
  createdAt: string;
  updatedAt: string;
  new: boolean;
  featured: boolean;
  submitted_by: string;
  category: string;
  clobTokenIds: string[];
}

// ============================================
// 内部市场类型
// ============================================

/** 市场实体 */
export interface Market {
  id: string;
  title: string;
  conditionId: string;
  tokenYes: string;
  tokenNo: string;
  active: boolean;
  createdAt?: string;
  updatedAt?: string;
}

/** Token 到 Market 的映射 */
export interface MarketMapping {
  marketId: string;
  marketTitle: string;
  outcomeSide: OutcomeSide;
}

/** Token 映射表类型 */
export type TokenMap = Map<string, MarketMapping>;

// ============================================
// 模块接口
// ============================================

export interface IMarketService {
  /** 从 Gamma API 获取市场列表 */
  fetchMarkets(options?: FetchMarketsOptions): Promise<GammaMarketResponse[]>;

  /** 构建 Token 映射表 */
  buildTokenMapping(markets: GammaMarketResponse[]): TokenMap;

  /** 转换为内部 Market 格式 */
  toMarket(gamma: GammaMarketResponse): Market;

  /** 获取映射（带缓存和降级） */
  getTokenMapping(): Promise<TokenMap>;

  /** 保存到本地缓存 */
  saveToCache(markets: Market[], tokenMap: TokenMap): Promise<void>;

  /** 从本地缓存加载 */
  loadFromCache(): Promise<{ markets: Market[]; tokenMap: TokenMap } | null>;
}

export interface FetchMarketsOptions {
  active?: boolean;
  limit?: number;
  offset?: number;
}

// ============================================
// 配置类型
// ============================================

export interface MarketServiceConfig {
  apiBaseUrl: string;
  cacheDir: string;
  cacheTTL: number;  // 毫秒
}

export const DEFAULT_MARKET_CONFIG: MarketServiceConfig = {
  apiBaseUrl: 'https://gamma-api.polymarket.com',
  cacheDir: './data',
  cacheTTL: 60 * 60 * 1000,  // 1小时
};
```

---

## 3. 模块B - Scanner

### types/scanner.ts

```typescript
import { Address, TxHash, BlockNumber, Bytes32 } from './common';

// ============================================
// 原始日志类型
// ============================================

/** eth_getLogs 返回的原始日志 */
export interface RawLog {
  address: Address;
  topics: Bytes32[];
  data: string;
  blockNumber: BlockNumber;
  blockHash: Bytes32;
  transactionHash: TxHash;
  transactionIndex: number;
  logIndex: number;
  removed: boolean;
}

/** 处理后的 OrderFilled 日志 */
export interface OrderFilledLog extends RawLog {
  // topics[0] 是事件签名
  // topics[1] 是 orderHash (indexed)
  // topics[2] 是 maker (indexed)
  // topics[3] 是 taker (indexed)
}

// ============================================
// 扫描结果类型
// ============================================

export interface ScanResult {
  logs: OrderFilledLog[];
  fromBlock: BlockNumber;
  toBlock: BlockNumber;
  scannedBlocks: number;
  totalLogs: number;
}

export interface ScanProgress {
  currentBlock: BlockNumber;
  targetBlock: BlockNumber;
  logsFound: number;
  percentage: number;
}

// ============================================
// 模块接口
// ============================================

export interface IScanner {
  /** 获取最新区块号 */
  getLatestBlockNumber(): Promise<BlockNumber>;

  /** 扫描 OrderFilled 日志 */
  scanOrderFilledLogs(options?: ScanOptions): Promise<ScanResult>;

  /** 获取单个区块范围的日志 */
  getLogs(params: GetLogsParams): Promise<RawLog[]>;

  /** 进度回调 */
  onProgress?: (progress: ScanProgress) => void;
}

export interface ScanOptions {
  fromBlock?: BlockNumber;
  toBlock?: BlockNumber;
  blockRange?: number;
  minLogs?: number;
  maxIterations?: number;
}

export interface GetLogsParams {
  fromBlock: BlockNumber | 'latest';
  toBlock: BlockNumber | 'latest';
  address: Address | Address[];
  topics: (Bytes32 | null)[];
}

// ============================================
// 配置类型
// ============================================

export interface ScannerConfig {
  rpcUrl: string;
  contractAddresses: Address[];
  blockRange: number;
  minLogs: number;
  retryConfig: RetryConfig;
}

export interface RetryConfig {
  maxRetries: number;
  baseDelay: number;
  maxDelay: number;
  backoffMultiplier: number;
}

export const DEFAULT_SCANNER_CONFIG: ScannerConfig = {
  rpcUrl: '',
  contractAddresses: [
    '0x4bFb41d5B3570DeFd03C39a9A4D8dE6Bd8B8982E',  // Current
    '0xC5d563A36AE78145C45a50134d48A1215220f80a',  // Legacy
  ],
  blockRange: 20000,
  minLogs: 100,
  retryConfig: {
    maxRetries: 3,
    baseDelay: 1000,
    maxDelay: 10000,
    backoffMultiplier: 2,
  },
};

// ============================================
// 合约常量
// ============================================

export const ORDER_FILLED_TOPIC =
  '0xd0a08e8c493f9c94f29311604c9de1b4e8c8d4c06bd0c789af57f2d65b8e4c2b';

export const ORDER_FILLED_ABI = [
  {
    anonymous: false,
    inputs: [
      { indexed: true, name: 'orderHash', type: 'bytes32' },
      { indexed: true, name: 'maker', type: 'address' },
      { indexed: true, name: 'taker', type: 'address' },
      { indexed: false, name: 'makerAssetId', type: 'uint256' },
      { indexed: false, name: 'takerAssetId', type: 'uint256' },
      { indexed: false, name: 'makerAmountFilled', type: 'uint256' },
      { indexed: false, name: 'takerAmountFilled', type: 'uint256' },
      { indexed: false, name: 'fee', type: 'uint256' },
    ],
    name: 'OrderFilled',
    type: 'event',
  },
] as const;
```

---

## 4. 模块C - Decoder

### types/decoder.ts

```typescript
import { Address, TxHash, BlockNumber, Bytes32, BigIntString } from './common';
import { OrderFilledLog } from './scanner';

// ============================================
// 解码后的交易类型
// ============================================

/** 解码后的 OrderFilled 事件数据 */
export interface DecodedTrade {
  // 链上元数据
  txHash: TxHash;
  blockNumber: BlockNumber;
  logIndex: number;
  timestamp?: string;

  // 解码字段
  orderHash: Bytes32;
  maker: Address;
  taker: Address;
  makerAssetId: BigIntString;
  takerAssetId: BigIntString;
  makerAmountFilled: BigIntString;
  takerAmountFilled: BigIntString;
  fee: BigIntString;
}

/** 解码结果 */
export interface DecodeResult {
  trades: DecodedTrade[];
  totalDecoded: number;
  failedCount: number;
  errors: DecodeError[];
}

export interface DecodeError {
  log: OrderFilledLog;
  error: string;
}

// ============================================
// 模块接口
// ============================================

export interface IDecoder {
  /** 解码单条日志 */
  decodeLog(log: OrderFilledLog): DecodedTrade;

  /** 批量解码日志 */
  decodeLogs(logs: OrderFilledLog[]): DecodeResult;

  /** 验证解码结果 */
  validateTrade(trade: DecodedTrade): ValidationResult;
}

export interface ValidationResult {
  valid: boolean;
  errors: string[];
}

// ============================================
// 解码选项
// ============================================

export interface DecodeOptions {
  skipInvalid: boolean;  // 跳过无效记录
  includeTimestamp: boolean;  // 是否获取区块时间戳
}

export const DEFAULT_DECODE_OPTIONS: DecodeOptions = {
  skipInvalid: true,
  includeTimestamp: false,
};
```

---

## 5. 模块D - Resolver

### types/resolver.ts

```typescript
import { Direction, OutcomeSide } from './common';
import { DecodedTrade } from './decoder';
import { TokenMap, Market } from './market';

// ============================================
// 归类后的交易类型
// ============================================

/** 归类后的完整交易数据 */
export interface ResolvedTrade extends DecodedTrade {
  // 归类字段
  tokenId: string;
  marketId: string | null;
  marketTitle: string | null;
  outcomeSide: OutcomeSide | null;
  direction: Direction;
  price: number;

  // 状态标记
  isResolved: boolean;
  priceAnomaly: boolean;
}

/** 归类结果 */
export interface ResolveResult {
  trades: ResolvedTrade[];
  totalResolved: number;
  resolvedCount: number;
  unresolvedCount: number;
  priceAnomalies: number;
  unknownTokenIds: string[];
}

// ============================================
// 模块接口
// ============================================

export interface IResolver {
  /** 归类单条交易 */
  resolveTrade(trade: DecodedTrade): ResolvedTrade;

  /** 批量归类交易 */
  resolveTrades(trades: DecodedTrade[]): ResolveResult;

  /** 判定 TokenId */
  determineTokenId(
    makerAssetId: string,
    takerAssetId: string
  ): string | null;

  /** 判定交易方向 */
  determineDirection(
    tokenId: string,
    makerAssetId: string
  ): Direction;

  /** 计算价格 */
  calculatePrice(
    makerAmount: bigint,
    takerAmount: bigint,
    direction: Direction
  ): number;
}

// ============================================
// 配置类型
// ============================================

export interface ResolverConfig {
  tokenMap: TokenMap;
  marketsMap: Map<string, Market>;
  priceValidation: PriceValidationConfig;
}

export interface PriceValidationConfig {
  minPrice: number;
  maxPrice: number;
  markAnomalyOutOfRange: boolean;
}

export const DEFAULT_PRICE_CONFIG: PriceValidationConfig = {
  minPrice: 0,
  maxPrice: 1,
  markAnomalyOutOfRange: true,
};
```

---

## 6. 模块E - Repository

### types/repository.ts

```typescript
import { Address, Direction, OutcomeSide, TagSource, PaginationParams } from './common';
import { Market } from './market';
import { ResolvedTrade } from './resolver';

// ============================================
// 数据库实体类型
// ============================================

/** 数据库中的 Trade 实体 */
export interface TradeEntity {
  id: number;
  txHash: string;
  logIndex: number;
  blockNumber: number;
  timestamp: string | null;
  orderHash: string;
  maker: string;
  taker: string;
  makerAssetId: string;
  takerAssetId: string;
  makerAmountFilled: string;
  takerAmountFilled: string;
  fee: string;
  tokenId: string | null;
  marketId: string | null;
  outcomeSide: string | null;
  direction: string;
  price: number | null;
  isResolved: boolean;
  createdAt: string;
}

/** 数据库中的 Market 实体 */
export interface MarketEntity {
  id: string;
  title: string;
  conditionId: string;
  tokenYes: string;
  tokenNo: string;
  active: boolean;
  createdAt: string;
  updatedAt: string;
}

/** 数据库中的 AddressTag 实体 */
export interface AddressTagEntity {
  id: number;
  address: string;
  tag: string;
  source: string;
  createdAt: string;
}

// ============================================
// 查询参数类型
// ============================================

export interface TradeQueryOptions extends PaginationParams {
  marketId?: string;
  address?: string;  // maker 或 taker
  direction?: Direction;
  startTime?: string;
  endTime?: string;
  orderBy?: TradeOrderBy;
}

export type TradeOrderBy =
  | 'blockNumber_desc'
  | 'blockNumber_asc'
  | 'timestamp_desc'
  | 'timestamp_asc'
  | 'price_desc'
  | 'price_asc';

export interface MarketQueryOptions extends PaginationParams {
  active?: boolean;
  sortBy?: MarketSortBy;
}

export type MarketSortBy = 'tradeCount' | 'volume' | 'recent';

export interface TraderQueryOptions extends PaginationParams {
  tag?: string;
  sortBy?: TraderSortBy;
  window?: string;  // '24h' | '7d' | '30d'
}

export type TraderSortBy = 'tradeCount' | 'volume' | 'activity';

// ============================================
// 统计类型
// ============================================

export interface MarketStats {
  marketId: string;
  marketTitle: string;
  tradeCount: number;
  volume: number;
  avgPrice: number;
  lastPrice: number;
  lastTradeAt: string | null;
}

export interface TraderStats {
  address: string;
  tradeCount: number;
  marketCount: number;
  totalVolume: number;
  lastActiveAt: string | null;
  tags: string[];
}

// ============================================
// 模块接口
// ============================================

export interface IRepository {
  // Markets
  upsertMarket(market: Market): Promise<void>;
  upsertMarkets(markets: Market[]): Promise<number>;
  getMarkets(options?: MarketQueryOptions): Promise<MarketEntity[]>;
  getMarketById(id: string): Promise<MarketEntity | null>;
  getMarketCount(): Promise<number>;

  // Trades
  insertTrade(trade: ResolvedTrade): Promise<void>;
  insertTrades(trades: ResolvedTrade[]): Promise<number>;
  getTrades(options?: TradeQueryOptions): Promise<TradeEntity[]>;
  getTradesByMarket(marketId: string, options?: PaginationParams): Promise<TradeEntity[]>;
  getTradesByAddress(address: string, options?: PaginationParams): Promise<TradeEntity[]>;
  getTradeCount(options?: TradeQueryOptions): Promise<number>;

  // Address Tags
  addTag(address: string, tag: string, source?: TagSource): Promise<AddressTagEntity>;
  removeTag(address: string, tag: string): Promise<void>;
  getTagsByAddress(address: string): Promise<AddressTagEntity[]>;
  getAddressesByTag(tag: string): Promise<string[]>;

  // Statistics
  getMarketStats(options?: MarketQueryOptions): Promise<MarketStats[]>;
  getTraderStats(options?: TraderQueryOptions): Promise<TraderStats[]>;
}

// ============================================
// 写入结果类型
// ============================================

export interface InsertResult {
  inserted: number;
  skipped: number;
  errors: number;
}
```

---

## 7. 模块F - API

### types/api.ts

```typescript
import { ApiResponse, Pagination, PaginationParams, Direction } from './common';
import { TradeEntity, MarketEntity, MarketStats, TraderStats } from './repository';

// ============================================
// API 请求参数类型
// ============================================

/** GET /api/trades 请求参数 */
export interface GetTradesParams extends PaginationParams {
  marketId?: string;
  address?: string;
  direction?: Direction;
}

/** GET /api/markets 请求参数 */
export interface GetMarketsParams extends PaginationParams {
  sortBy?: 'tradeCount' | 'volume' | 'recent';
  window?: '24h' | '7d' | '30d';
}

/** GET /api/traders 请求参数 */
export interface GetTradersParams extends PaginationParams {
  tag?: string;
  sortBy?: 'tradeCount' | 'volume' | 'activity';
  window?: '24h' | '7d' | '30d';
}

/** POST /api/tags 请求体 */
export interface CreateTagRequest {
  address: string;
  tag: string;
}

/** DELETE /api/tags 请求参数 */
export interface DeleteTagParams {
  address: string;
  tag: string;
}

// ============================================
// API 响应数据类型
// ============================================

/** Trade 响应数据（包含关联的 market） */
export interface TradeResponse extends Omit<TradeEntity, 'marketId'> {
  market: {
    id: string;
    title: string;
  } | null;
}

/** Market 响应数据（包含统计） */
export interface MarketResponse extends MarketEntity {
  stats: {
    tradeCount: number;
    volume: number;
    avgPrice: number;
    lastPrice: number;
    lastTradeAt: string | null;
  };
}

/** Market 详情响应（包含价格历史和最近交易） */
export interface MarketDetailResponse {
  market: MarketEntity;
  stats: MarketStats;
  priceHistory: PricePoint[];
  recentTrades: TradeResponse[];
}

export interface PricePoint {
  timestamp: string;
  price: number;
}

/** Trader 响应数据 */
export interface TraderResponse extends TraderStats {
  // TraderStats 已包含所有需要的字段
}

/** Trader 详情响应 */
export interface TraderDetailResponse {
  address: string;
  stats: TraderStats;
  tags: TagResponse[];
  markets: MarketParticipation[];
  recentTrades: TradeResponse[];
}

export interface MarketParticipation {
  marketId: string;
  marketTitle: string;
  tradeCount: number;
  volume: number;
}

/** Tag 响应数据 */
export interface TagResponse {
  id: number;
  address: string;
  tag: string;
  source: string;
  createdAt: string;
}

// ============================================
// API 响应类型（完整）
// ============================================

export type GetTradesResponse = ApiResponse<TradeResponse[]>;
export type GetMarketsResponse = ApiResponse<MarketResponse[]>;
export type GetMarketDetailResponse = ApiResponse<MarketDetailResponse>;
export type GetTradersResponse = ApiResponse<TraderResponse[]>;
export type GetTraderDetailResponse = ApiResponse<TraderDetailResponse>;
export type CreateTagResponse = ApiResponse<TagResponse>;
export type DeleteTagResponse = ApiResponse<{ success: boolean }>;
```

---

## 8. 模块G - Frontend

### types/frontend.ts

```typescript
import { TradeResponse, MarketResponse, TraderResponse } from './api';
import { Pagination } from './common';

// ============================================
// 组件 Props 类型
// ============================================

/** TradesTable 组件 Props */
export interface TradesTableProps {
  trades: TradeResponse[];
  loading: boolean;
  error?: string;
  pagination: Pagination;
  onPageChange: (page: number) => void;
  onRowClick?: (trade: TradeResponse) => void;
}

/** TradeRow 组件 Props */
export interface TradeRowProps {
  trade: TradeResponse;
  expanded: boolean;
  onToggle: () => void;
}

/** TradeDetail 组件 Props */
export interface TradeDetailProps {
  trade: TradeResponse;
}

/** TopMarkets 组件 Props */
export interface TopMarketsProps {
  markets: MarketResponse[];
  loading: boolean;
  onMarketClick?: (market: MarketResponse) => void;
}

/** PriceChart 组件 Props */
export interface PriceChartProps {
  data: PriceChartData;
  loading: boolean;
}

export interface PriceChartData {
  marketId: string;
  marketTitle: string;
  points: Array<{
    timestamp: string;
    price: number;
  }>;
}

/** TopTraders 组件 Props */
export interface TopTradersProps {
  traders: TraderResponse[];
  loading: boolean;
  onTraderClick?: (trader: TraderResponse) => void;
}

/** AddressDrawer 组件 Props */
export interface AddressDrawerProps {
  address: string;
  open: boolean;
  onClose: () => void;
}

/** TagChip 组件 Props */
export interface TagChipProps {
  tag: string;
  removable?: boolean;
  onRemove?: () => void;
}

/** Pagination 组件 Props */
export interface PaginationProps {
  pagination: Pagination;
  onPageChange: (page: number) => void;
}

// ============================================
// Hook 返回类型
// ============================================

export interface UseTradesResult {
  trades: TradeResponse[];
  pagination: Pagination;
  loading: boolean;
  error: string | null;
  refetch: () => void;
}

export interface UseMarketsResult {
  markets: MarketResponse[];
  loading: boolean;
  error: string | null;
  refetch: () => void;
}

export interface UseTradersResult {
  traders: TraderResponse[];
  pagination: Pagination;
  loading: boolean;
  error: string | null;
  refetch: () => void;
}

// ============================================
// 状态类型
// ============================================

export interface DashboardState {
  selectedMarketId: string | null;
  selectedAddress: string | null;
  tradeFilters: TradeFilters;
}

export interface TradeFilters {
  marketId?: string;
  address?: string;
  direction?: 'BUY' | 'SELL';
}
```

---

## 9. Prisma Schema

### prisma/schema.prisma

```prisma
// ============================================
// Prisma 配置
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// 数据模型
// ============================================

/// 市场表
model Market {
  id          String   @id                          /// 市场 ID
  title       String                                /// 市场标题
  conditionId String   @map("condition_id")         /// 条件 ID
  tokenYes    String   @map("token_yes")            /// YES token ID
  tokenNo     String   @map("token_no")             /// NO token ID
  active      Boolean  @default(true)               /// 是否活跃
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  trades Trade[]

  @@index([conditionId])
  @@map("markets")
}

/// 交易表
model Trade {
  id                Int       @id @default(autoincrement())
  txHash            String    @map("tx_hash")       /// 交易哈希
  logIndex          Int       @map("log_index")     /// 日志索引
  blockNumber       Int       @map("block_number")  /// 区块号
  timestamp         DateTime?                       /// 时间戳
  orderHash         String    @map("order_hash")    /// 订单哈希
  maker             String                          /// Maker 地址
  taker             String                          /// Taker 地址
  makerAssetId      String    @map("maker_asset_id")      /// Maker 资产 ID
  takerAssetId      String    @map("taker_asset_id")      /// Taker 资产 ID
  makerAmountFilled String    @map("maker_amount_filled") /// Maker 成交量
  takerAmountFilled String    @map("taker_amount_filled") /// Taker 成交量
  fee               String                          /// 手续费
  tokenId           String?   @map("token_id")      /// Outcome Token ID
  marketId          String?   @map("market_id")     /// 市场 ID
  outcomeSide       String?   @map("outcome_side")  /// YES/NO
  direction         String                          /// BUY/SELL
  price             Float?                          /// 成交价格 (0-1)
  isResolved        Boolean   @default(false) @map("is_resolved")

  market Market? @relation(fields: [marketId], references: [id])

  @@unique([txHash, logIndex])
  @@index([maker])
  @@index([taker])
  @@index([tokenId])
  @@index([marketId])
  @@index([blockNumber])
  @@index([timestamp])
  @@map("trades")
}

/// 地址标签表
model AddressTag {
  id        Int      @id @default(autoincrement())
  address   String                                  /// 钱包地址
  tag       String                                  /// 标签名
  source    String   @default("manual")             /// 来源: manual/auto
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([address, tag])
  @@index([address])
  @@index([tag])
  @@map("address_tags")
}
```

---

## 10. Zod Validation Schema

### lib/validators.ts

```typescript
import { z } from 'zod';

// ============================================
// 通用校验
// ============================================

/** 以太坊地址校验 */
export const addressSchema = z
  .string()
  .regex(/^0x[a-fA-F0-9]{40}$/, 'Invalid Ethereum address');

/** 交易哈希校验 */
export const txHashSchema = z
  .string()
  .regex(/^0x[a-fA-F0-9]{64}$/, 'Invalid transaction hash');

/** 分页参数校验 */
export const paginationSchema = z.object({
  limit: z.coerce.number().min(1).max(100).default(20),
  offset: z.coerce.number().min(0).default(0),
});

// ============================================
// API 请求校验
// ============================================

/** GET /api/trades 参数校验 */
export const getTradesSchema = paginationSchema.extend({
  marketId: z.string().optional(),
  address: addressSchema.optional(),
  direction: z.enum(['BUY', 'SELL']).optional(),
});

export type GetTradesInput = z.infer<typeof getTradesSchema>;

/** GET /api/markets 参数校验 */
export const getMarketsSchema = paginationSchema.extend({
  sortBy: z.enum(['tradeCount', 'volume', 'recent']).default('tradeCount'),
  window: z.enum(['24h', '7d', '30d']).default('24h'),
});

export type GetMarketsInput = z.infer<typeof getMarketsSchema>;

/** GET /api/traders 参数校验 */
export const getTradersSchema = paginationSchema.extend({
  tag: z.string().optional(),
  sortBy: z.enum(['tradeCount', 'volume', 'activity']).default('activity'),
  window: z.enum(['24h', '7d', '30d']).default('7d'),
});

export type GetTradersInput = z.infer<typeof getTradersSchema>;

/** POST /api/tags 请求体校验 */
export const createTagSchema = z.object({
  address: addressSchema,
  tag: z.string().min(1).max(50),
});

export type CreateTagInput = z.infer<typeof createTagSchema>;

/** DELETE /api/tags 参数校验 */
export const deleteTagSchema = z.object({
  address: addressSchema,
  tag: z.string().min(1),
});

export type DeleteTagInput = z.infer<typeof deleteTagSchema>;

// ============================================
// 数据校验
// ============================================

/** 解码交易校验 */
export const decodedTradeSchema = z.object({
  txHash: txHashSchema,
  blockNumber: z.number().positive(),
  logIndex: z.number().min(0),
  orderHash: z.string().regex(/^0x[a-fA-F0-9]{64}$/),
  maker: addressSchema,
  taker: addressSchema,
  makerAssetId: z.string().min(1),
  takerAssetId: z.string().min(1),
  makerAmountFilled: z.string().min(1),
  takerAmountFilled: z.string().min(1),
  fee: z.string().min(1),
});

/** 价格校验 */
export const priceSchema = z.number().min(0).max(1);

// ============================================
// 辅助函数
// ============================================

/** 安全解析（返回 result 而非抛异常） */
export function safeValidate<T>(
  schema: z.ZodSchema<T>,
  data: unknown
): { success: true; data: T } | { success: false; error: z.ZodError } {
  const result = schema.safeParse(data);
  return result;
}
```

---

## 附录：类型文件索引

| 文件 | 内容 |
|------|------|
| `types/common.ts` | 通用类型、枚举、分页、API 响应 |
| `types/market.ts` | Gamma API、Market、TokenMap |
| `types/scanner.ts` | RawLog、ScanResult、配置 |
| `types/decoder.ts` | DecodedTrade、DecodeResult |
| `types/resolver.ts` | ResolvedTrade、ResolveResult |
| `types/repository.ts` | 数据库实体、查询参数、统计 |
| `types/api.ts` | API 请求/响应类型 |
| `types/frontend.ts` | 组件 Props、Hook 返回类型 |
| `lib/validators.ts` | Zod 校验 Schema |
| `prisma/schema.prisma` | Prisma 数据模型 |
